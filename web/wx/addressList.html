<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="renderer" content="webkit" />
    <link rel="dns-prefetch" href="//test.cn-qch.com/" />
    <link rel="dns-prefetch" href="//www.cn-qch.com/" />
    <title>地址列表</title>
    <link rel="stylesheet" href="/wx/css/public.css">
    <link rel="stylesheet" href="/wx/css/addressList.css">
</head>

<body>
    <div class="container">
        <table class="listbox" cellpadding="0" cellspacing="0"></table>
        <p class="nodata hide">您还没有收货地址哦！请点击下方按钮新建收货地址</p>
    </div>
    <div class="loading"></div>
    <script type="text/html" id="listTemplate">
        <%data.forEach(function(item,index){%>
            <tr <%if(item.t_IsDefault){%>class="active"<%}%>>
                <td>
                    <a class="selectaddr">
                        <h2><%=item.t_Cnee_Name%> &nbsp;&nbsp;&nbsp;&nbsp;<%=item.t_Cnee_Phone.slice(0,3)+'****'+item.t_Cnee_Phone.slice(7)%></h2>
                        <p><%=item.t_Cnee_Addr%></p>
                    </a>
                </td>
                <td>
                    <a class="btn-edit" data-guid="<%=item.guid%>"></a>
                </td>
            </tr>
        <%})%>
    </script>
    <div class="newaddress">
        <a href="/wx/addAddress.html?typeId=1">+ 新建地址</a>
    </div>
    <script src="/h5/js/jquery.min.js"></script>
    <script src="/wx/js/jquery.mobile-events.min.js"></script>
    <script src="/wx/js/artTemplate.js"></script>
    <script src="/h5/js/util.js"></script>
    <script>
        var userguid=sessionStorage.getItem('userguid');
        var addressData=[];
        // 获取用户所有收货地址
        $.ajax({
            url:'http://120.25.106.244:9001/api/cnee/GetReceiptByUserId',
            cache:false,
            data:{UserGuid:userguid},
            success:function(res){
                if(res&&res.length){
                    addressData=res;
                    $('.listbox').html(template('listTemplate',{data:res}));
                }else{
                    $('.nodata').removeClass('hide');
                }
                $('.loading').remove();
            }
        })
        // 编辑收货地址
        $('body').on('tap','.btn-edit',function(){
            var index=$(this).parents('tr').index();
            sessionStorage.setItem('username',addressData[index].t_Cnee_Name);
            sessionStorage.setItem('phone',addressData[index].t_Cnee_Phone);
            sessionStorage.setItem('isdefault',addressData[index].t_IsDefault);
            var arr=addressData[index].t_Cnee_Addr.split(' ');
            var field='';
            var num=arr.length>3?3:2;
            for(var i=0;i<num;i++){
                field+=arr[i]+' ';
            }
            sessionStorage.setItem('field2',field.trimRight());
            sessionStorage.setItem('addressdetail',arr[num]);
            sessionStorage.setItem('addressguid',$(this).data('guid'));
            location.href='/wx/addressEdit.html';
        })
        // 选择地址
        .on('tap','.selectaddr',function(){
            var index=$(this).parents('tr').index();
            var addressInfo={};
            addressInfo.t_Cnee_Addr=addressData[index].t_Cnee_Addr;
            addressInfo.t_Cnee_Name=addressData[index].t_Cnee_Name;
            addressInfo.t_Cnee_Phone=addressData[index].t_Cnee_Phone;
            addressInfo.guid=addressData[index].guid;
            addressInfo=JSON.stringify(addressInfo);
            sessionStorage.setItem('addressinfo',addressInfo);
            location.assign('/wx/confirmOrder.html');
        })
        function removeSession(){
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('phone');
            sessionStorage.removeItem('isdefault');
            sessionStorage.removeItem('field');
            sessionStorage.removeItem('field2');
            sessionStorage.removeItem('addressdetail');
        }
        removeSession();
    </script>
</body>
</html>