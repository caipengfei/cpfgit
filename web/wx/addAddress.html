<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="renderer" content="webkit" />
    <link rel="dns-prefetch" href="//test.cn-qch.com/" />
    <link rel="dns-prefetch" href="//www.cn-qch.com/" />
    <title>新建收货地址</title>
    <link rel="stylesheet" href="/wx/css/public.css">
    <link rel="stylesheet" href="/wx/css/addAddress.css">
</head>

<body>
    <div class="container">
        <ul class="myform">
            <li>
                <label for="username">收货人:</label>
                <input type="text" name="username" id="username" value="">
            </li>
            <li>
                <label for="phone">手机号码:</label>
                <input type="tel" name="phone" id="phone" value="" maxlength="11">
            </li>
            <li>
                <label>所在地区:</label>
                <a id="goSelectAddress" href="/wx/selectAddress.html?typeId=1"></a>
            </li>
            <li>
                <label for="address">详细地址:</label>
                <input type="text" name="address" id="address" value="" placeholder="街道，楼牌号等">
            </li>
        </ul>
        <div class="mrbox">
            <div class="row">
                <div class="cell">
                    <h2>默认地址</h2>
                    <p>注： 每次下单时会使用该地址</p>
                </div>
                <div class="cell">
                    <a id="setDefault"></a>
                </div>
            </div>
        </div>
        <a class="btn-submit">保存并使用</a>
    </div>
    <script src="/h5/js/jquery.min.js"></script>
    <script src="/wx/js/jquery.mobile-events.min.js"></script>
    <script src="/h5/js/util.js"></script>
    <script>
        var regPhone = /^([1]((3|5|7|8)[0-9]{1})[0-9]{8})$/;
        // 从会话获取用户guid和所在地区
        var userguid=sessionStorage.getItem('userguid');
        function resize(){
            // 设置input宽度
            $('.myform input,.myform a').each(function(){
                var $li=$(this).parent('li');
                $(this).css({
                    width:$li.width()-$(this).siblings('label').width()-1
                });
            });
        }
        $(function(){
            $(window).resize(resize).resize();
            // 会话存储用户名
            $('#username').keyup(function(){
                sessionStorage.setItem('username',$(this).val());
            })
            // 禁止输入非数值并会话存储用户手机号
            $('#phone').keyup(function(){
                sessionStorage.setItem('phone',$(this).val());
            });
            // 会话存储详细地址
            $('#address').keyup(function(){
                sessionStorage.setItem('addressdetail',$(this).val());
            })
            // 设置默认地址
            $('#setDefault').tap(function(){
                $(this).toggleClass('active');
                sessionStorage.setItem('isdefault',$(this).hasClass('active'));
            })
            // 保存并使用该地址 成功跳转至订单页
            $('.btn-submit').on('tap',function(){
                var $username=$('#username');
                var $phone=$('#phone');
                var field=$('#goSelectAddress').text().trim();
                var $address=$('#address');
                var isDefault=$('#setDefault').hasClass('active')?1:0;
                if (!validField($username, null, '请输入收货人！')) return;
                if (!validField($phone, regPhone, '请输入手机号！', '手机号格式有误')) return;
                if(!field) {
                    util.msgBox('请选择所在地区');
                    return;
                }
                if (!validField($address, null, '请输入详细地址！')) return;
                $.ajax({
                    type: 'post',
                    cache: false,
                    dataType: 'json',
                    url: 'http://120.25.106.244:9001/api/cnee/Save',
                    data: {
                        Guid: '',
                        t_User_Guid: userguid,
                        t_Cnee_Name: $username.val(),
                        t_Cnee_Phone: $phone.val(),
                        t_Cnee_Addr: field+' '+$address.val(),
                        t_IsDefault: isDefault,
                        t_DelState: 0
                    },
                    success: function (res) {
                        var addressInfo={};
                        addressInfo.t_Cnee_Addr=field+' '+$address.val();
                        addressInfo.t_Cnee_Name=$username.val();
                        addressInfo.t_Cnee_Phone=$phone.val();
                        addressInfo.guid=res.result;
                        addressInfo=JSON.stringify(addressInfo);
                        sessionStorage.setItem('addressinfo',addressInfo);
                        removeSession();
                        location.href='/wx/confirmOrder.html';
                    }
                })
            })
        })
        // 验证文本框
        function validField($input, reg, helpText1, helpText2) {
            var value = $.trim($input[0].value);
            if (!value) {
                util.msgBox(helpText1);
                $input[0].value = '';
                return false;
            } else {
                if (reg && !reg.test(value)) {
                util.msgBox(helpText2);
                    return false;
                }
            }
            return true;
        }
        function getSession(){
            var username=sessionStorage.getItem('username');
            var phone=sessionStorage.getItem('phone');
            var addressdetail=sessionStorage.getItem('addressdetail');
            var isdefault=sessionStorage.getItem('isdefault');
            var field=sessionStorage.getItem('field');
            // {"provinceText":"吉林省","cityText":"四平","disText":"梨树县"}
            if(field){
                field=JSON.parse(field);
                $('#goSelectAddress').text(field.provinceText+' '+field.cityText+' '+field.disText);
            }
            $('#username').val(username);
            $('#phone').val(phone);
            if(addressdetail){
                $('#address').val(addressdetail);
            }
            if(isdefault){
                $('#setDefault').addClass('active');
            }
        }
        function removeSession(){
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('phone');
            sessionStorage.removeItem('isdefault');
            sessionStorage.removeItem('field');
            sessionStorage.removeItem('field2');
            sessionStorage.removeItem('addressdetail');
            sessionStorage.removeItem('addressguid');
        }
        getSession();
    </script>
</body>
</html>